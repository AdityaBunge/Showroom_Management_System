{% extends "base.html" %}
{% load static %}
{% block title %}Sales - Showroom{% endblock %}

{% block page_title %}Sales{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row align-items-center mb-3">
    <div class="col-md-8">
      <h1 class="h3 mb-0">Sales</h1>
      <p class="text-muted mb-0">Manage your sales records and transactions</p>
    </div>
    <div class="col-md-4 text-md-end mt-3 mt-md-0">
       <button id="openCreateSaleModal" style="padding:.6rem 1.1rem; border-radius:8px; background:#2563EB; color:#fff; border:0;">
      + Add New Sale
    </button>
    </div>
  </div>

   <div class="card shadow-sm mt-2">
    <div class="card-body p-0">
      <div class="table-responsive" style="min-height: 200px;">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th style="width:60px;">ID</th>
              <th>Car</th>
              <th>Customer</th>
              <th style="width:140px;">Price</th>
              <th style="width:190px;">Date</th>
              <th style="width:190px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for sale in sales %}
            <tr>
              <td class="align-middle">{{ sale.id }}</td>
              <td class="align-middle">
                <div class="fw-bold">{{ sale.car }}</div>
                <div class="small text-muted">{{ sale.car.get_trim_display|default_if_none:"" }}</div>
              </td>
              <td class="align-middle">
                <div class="fw-bold">{{ sale.customer.name|default:sale.customer }}</div>
                <div class="small text-muted">{{ sale.customer.phone }}</div>
              </td>
              <td class="align-middle">₹ {{ sale.sale_price|floatformat:2 }}</td>
              <td class="align-middle">{{ sale.sale_date|date:"M d, Y H:i" }}</td>
              <td class="align-middle">
                <div class="d-flex gap-2">
                  <a class="btn btn-sm btn-outline-info" href="{% url 'sales:sale-detail' sale.pk %}">View</a>
                  <a class="btn btn-sm btn-outline-warning" href="{% url 'sales:sale-update' sale.pk %}">Edit</a>
                  <a class="btn btn-sm btn-danger" href="{% url 'sales:sale-delete' sale.pk %}">Delete</a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center py-4 text-muted">
                No sales records found. Click “Add New Sale” to create one.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- pagination -->
  {% if is_paginated %}
  <nav class="mt-3 d-flex justify-content-end">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- Create Sale Modal (renders the Django form provided in the view context) -->
<div id="createSaleModal" class="modal" style="display:none;">
  <div class="modal-dialog" role="document" style="max-width:560px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Sale</h5>
        <button type="button" class="btn-close" aria-label="Close" onclick="closeCreateSaleModal()"></button>
      </div>
      <div class="modal-body">
        <form id="createSaleForm" method="post" action="{% url 'sales:sale-create' %}">
          {% csrf_token %}
          {{ form.non_field_errors }}
          <div class="mb-3">
            {{ form.car.label_tag }}
            {{ form.car }}
            {{ form.car.errors }}
          </div>
          <div class="mb-3">
            {{ form.customer.label_tag }}
            {{ form.customer }}
            {{ form.customer.errors }}
          </div>
          <div class="mb-3">
            {{ form.sale_price.label_tag }}
            {{ form.sale_price }}
            {{ form.sale_price.errors }}
          </div>

          <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-secondary me-2" onclick="closeCreateSaleModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Sale</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
/* Light styling to match customers page feel */
.card { border-radius: 12px; overflow: hidden; }
.table thead th { font-weight:700; background: #f6f8fb; border-bottom: none; }
.btn-outline-info { color: #0d6efd; border-color: #cfe5ff; background: transparent; }
.btn-outline-warning { color: #856404; border-color: #ffe8a8; background: transparent; }
.modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(10,10,10,0.45); z-index: 2050; }
.modal-dialog { transform: translateY(0); }
.btn-close { background: none; border: none; font-size: 1.25rem; }
.d-flex.gap-2 > * { margin-right: .5rem; }
</style>

<script>
/* Simple modal open/close handling */
function openCreateSaleModal() {
  document.getElementById('createSaleModal').style.display = 'flex';
}
function closeCreateSaleModal() {
  document.getElementById('createSaleModal').style.display = 'none';
}
document.getElementById('openCreateSaleModal').addEventListener('click', openCreateSaleModal);

// close modal when clicking outside modal-content
document.getElementById('createSaleModal').addEventListener('click', function(e){
  const dialog = document.querySelector('#createSaleModal .modal-dialog');
  if (e.target === this) { closeCreateSaleModal(); }
});
</script>

{% endblock %}
