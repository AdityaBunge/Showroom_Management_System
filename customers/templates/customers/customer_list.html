{% extends "base.html" %}
{% load static %}

{% block title %}Customer Management{% endblock %}
{% block page_title %}Customer Management{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div class="page-header-content">
            <h2>Customers</h2>
            <p class="page-subtitle">Manage your customer database</p>
        </div>
        <button class="btn btn-primary" onclick="openCustomerModal()">
            <i class="fas fa-plus"></i> Add New Customer
        </button>
    </div>
    
    <div class="card">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in customers %}
                        <tr data-customer-id="{{ customer.id }}"
                            data-first-name="{{ customer.first_name }}"
                            data-last-name="{{ customer.last_name }}"
                            data-email="{{ customer.email }}"
                            data-phone="{{ customer.phone_number|default:'' }}"
                            data-address="{{ customer.address|default:'' }}">
                            <td>{{ customer.id }}</td>
                            <td><strong>{{ customer.first_name }} {{ customer.last_name }}</strong></td>
                            <td>{{ customer.email }}</td>
                            <td>{{ customer.phone_number|default:"—" }}</td>
                            <td>{{ customer.address|default:"—"|truncatewords:5 }}</td>
                            <td>{{ customer.created_at|date:"M d, Y" }}</td>
                            <td>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-sm btn-secondary" onclick="editCustomer({{ customer.id }}, event)" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteCustomer({{ customer.id }}, '{{ customer.first_name }} {{ customer.last_name }}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-message">
                                    <i class="fas fa-users"></i>
                                    <p>No customers found. Click "Add New Customer" to get started.</p>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Customer Modal -->
<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add New Customer</h2>
            <span class="close" onclick="closeCustomerModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="customerForm" method="post" action="">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_first_name">First Name <span class="required">*</span></label>
                    <input type="text" name="first_name" id="id_first_name" required maxlength="30" class="form-control">
                </div>
                <div class="form-group">
                    <label for="id_last_name">Last Name <span class="required">*</span></label>
                    <input type="text" name="last_name" id="id_last_name" required maxlength="30" class="form-control">
                </div>
                <div class="form-group">
                    <label for="id_email">Email <span class="required">*</span></label>
                    <input type="email" name="email" id="id_email" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="id_phone_number">Phone Number</label>
                    <input type="text" name="phone_number" id="id_phone_number" maxlength="15" class="form-control">
                </div>
                <div class="form-group">
                    <label for="id_address">Address</label>
                    <textarea name="address" id="id_address" rows="3" class="form-control"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Customer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCustomerModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>Confirm Delete</h2>
            <span class="close" onclick="closeDeleteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete customer <strong id="deleteCustomerName"></strong>?</p>
            <p class="warning-text">This action cannot be undone.</p>
            <form id="deleteForm" method="post" action="">
                {% csrf_token %}
                <div class="form-actions">
                    <button type="submit" class="btn btn-danger">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.page-container {
    width: 100%;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.page-header-content h2 {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 4px 0;
}

.page-subtitle {
    color: var(--text-secondary);
    font-size: 14px;
    margin: 0;
}

.modal-header {
    background: var(--primary) !important;
    color: white !important;
}

.modal-header h2 {
    color: white !important;
}

.close {
    color: white !important;
}

.required {
    color: var(--danger);
}
</style>

<script>
// Customer Modal Functions
function openCustomerModal(customerId = null) {
    const modal = document.getElementById('customerModal');
    const form = document.getElementById('customerForm');
    const title = document.getElementById('modalTitle');
    
    if (customerId) {
        // Edit mode - will be handled by editCustomer
        title.textContent = 'Edit Customer';
        form.action = `/customers/${customerId}/edit/`;
    } else {
        // Add mode
        title.textContent = 'Add New Customer';
        form.action = '{% url "customers:customer-add" %}';
        form.reset();
    }
    
    modal.classList.add('show');
}

function closeCustomerModal() {
    const modal = document.getElementById('customerModal');
    modal.classList.remove('show');
    document.getElementById('customerForm').reset();
}

function editCustomer(customerId, event) {
    // Get customer data from the table row's data attributes
    const row = event.target.closest('tr');
    if (row && row.dataset.customerId) {
        // Extract data from data attributes
        const firstName = row.dataset.firstName || '';
        const lastName = row.dataset.lastName || '';
        const email = row.dataset.email || '';
        const phone = row.dataset.phone || '';
        const address = row.dataset.address || '';
        
        // Populate form
        document.getElementById('id_first_name').value = firstName;
        document.getElementById('id_last_name').value = lastName;
        document.getElementById('id_email').value = email;
        document.getElementById('id_phone_number').value = phone;
        document.getElementById('id_address').value = address;
        
        // Set form action and title
        document.getElementById('customerForm').action = `/customers/${customerId}/edit/`;
        document.getElementById('modalTitle').textContent = 'Edit Customer';
        document.getElementById('customerModal').classList.add('show');
    } else {
        // Fallback: redirect to edit page
        window.location.href = `/customers/${customerId}/edit/`;
    }
}

function deleteCustomer(customerId, customerName) {
    const modal = document.getElementById('deleteModal');
    const form = document.getElementById('deleteForm');
    const nameSpan = document.getElementById('deleteCustomerName');
    
    nameSpan.textContent = customerName;
    form.action = `/customers/${customerId}/delete/`;
    modal.classList.add('show');
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.remove('show');
}

// Close modal when clicking outside
window.onclick = function(event) {
    const customerModal = document.getElementById('customerModal');
    const deleteModal = document.getElementById('deleteModal');
    
    if (event.target == customerModal) {
        closeCustomerModal();
    }
    if (event.target == deleteModal) {
        closeDeleteModal();
    }
}

// Handle form submission and populate form on page load if editing
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('customerForm');
    if (form) {
        // Check if we're in edit mode by checking the URL
        const path = window.location.pathname;
        if (path.includes('/edit/')) {
            // Extract customer ID and set form action
            const match = path.match(/\/customers\/(\d+)\/edit\//);
            if (match) {
                form.action = path;
                document.getElementById('modalTitle').textContent = 'Edit Customer';
                document.getElementById('customerModal').classList.add('show');
            }
        }
    }
    
    // Populate form fields if we have customer data in the page context
    // This will be populated when the edit page loads
    {% if form %}
        {% if form.instance.pk %}
            // We're editing, populate the modal
            document.getElementById('id_first_name').value = '{{ form.instance.first_name|escapejs }}';
            document.getElementById('id_last_name').value = '{{ form.instance.last_name|escapejs }}';
            document.getElementById('id_email').value = '{{ form.instance.email|escapejs }}';
            document.getElementById('id_phone_number').value = '{{ form.instance.phone_number|escapejs }}';
            document.getElementById('id_address').value = '{{ form.instance.address|escapejs }}';
            document.getElementById('customerForm').action = '/customers/{{ form.instance.pk }}/edit/';
            document.getElementById('modalTitle').textContent = 'Edit Customer';
            document.getElementById('customerModal').classList.add('show');
        {% endif %}
    {% endif %}
});
</script>
{% endblock %}
